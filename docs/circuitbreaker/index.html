<!DOCTYPE html><html><head><title>rezilience: Circuit Breaker</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="vroste" /><meta name="description" content="ZIO-native utilities for making asynchronous systems more resilient to failures" /><meta name="og:image" content="/img/poster.png" /><meta name="image" property="og:image" content="/img/poster.png" /><meta name="og:title" content="rezilience: Circuit Breaker" /><meta name="title" property="og:title" content="rezilience: Circuit Breaker" /><meta name="og:site_name" content="rezilience" /><meta name="og:url" content="https://www.vroste.nl/rezilience/" /><meta name="og:type" content="website" /><meta name="og:description" content="ZIO-native utilities for making asynchronous systems more resilient to failures" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="rezilience: Circuit Breaker" /><meta name="twitter:image" content="https://svroonland.github.io/img/poster.png" /><meta name="twitter:description" content="ZIO-native utilities for making asynchronous systems more resilient to failures" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@vroste" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/vs.css" /><link rel="stylesheet" href="/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"></div><span>rezilience</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/docs/" title="Getting started" class="">Getting started</a></div> <div class="sidebar-nav-item  "><a href="/docs/general_usage" title="General Usage" class="">General Usage</a></div> <div class="sidebar-nav-item active "><a href="/docs/circuitbreaker" title="Circuit Breaker" class="active">Circuit Breaker</a></div> <div class="sidebar-nav-item  "><a href="/docs/bulkhead" title="Bulkhead" class="">Bulkhead</a></div> <div class="sidebar-nav-item  "><a href="/docs/ratelimiter" title="Rate Limiter" class="">Rate Limiter</a></div> <div class="sidebar-nav-item  "><a href="/docs/retry" title="Retry" class="">Retry</a></div> <div class="sidebar-nav-item  "><a href="/docs/combining_policies" title="Combining Policies" class="">Combining Policies</a></div> <div class="sidebar-nav-item  "><a href="/docs/additional_resiliency" title="Additional Resiliency" class="">Additional Resiliency</a></div> <div class="sidebar-nav-item  "><a href="/api/nl/vroste/rezilience/" title="API reference" class="">API reference</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/svroonland/rezilience" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/svroonland/rezilience" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="svroonland" data-github-repo="rezilience"><div class="content-wrapper"><section><h1 id="circuit-breaker">Circuit Breaker</h1>
<p>Circuit Breaker is a reactive resilience strategy to safeguard an external system against overload. It will also prevent queueing up of calls to an already struggling system.</p>

<h2 id="behavior">Behavior</h2>
<p>A Circuit Breaker starts in the ‘closed’ state. All calls are passed through in this state. Any failures are counted. When too many failures have occurred, the breaker goes to the ‘open’ state. Calls made in this state will fail immediately with a <code class="language-plaintext highlighter-rouge">CircuitBreakerOpen</code> error.</p>

<p>After some time, the circuit breaker will reset to the ‘half open’ state. In this state, one call can pass through. If this call succeeds, the circuit breaker goes back to the ‘closed’ state. If it fails, the breaker goes again to the ‘open’ state.</p>

<p>CircuitBreaker uses a ZIO <code class="language-plaintext highlighter-rouge">Schedule</code> to determine the reset interval. By default, this is an exponential backoff schedule, so that reset intervals double with each iteration, capped at some maximum value. You can however provide any <code class="language-plaintext highlighter-rouge">Schedule</code> that fits your needs.</p>

<h2 id="failure-counting-modes">Failure counting modes</h2>
<p>CircuitBreaker has two modes for counting failures:</p>

<ul>
  <li>Failure Count<br />
Trip the circuit breaker when the <em>number</em> of consecutive failing calls exceeds some threshold. This is implemented in <code class="language-plaintext highlighter-rouge">TrippingStrategy.failureCount</code></li>
  <li>Failure Rate<br />
Trip when the <em>proportion</em> of failing calls exceeds some threshold. The threshold and the sample period can be specified. You can specify a minimum call count to avoid tripping at very low call rates. This mode is implemented in <code class="language-plaintext highlighter-rouge">TrippingStrategy.failureRate</code></li>
</ul>

<p>Custom tripping strategies can be implemented by extending <code class="language-plaintext highlighter-rouge">TrippingStrategy</code>.</p>

<h2 id="usage-example">Usage example</h2>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">nl.vroste.rezilience.CircuitBreaker._</span>
<span class="k">import</span> <span class="nn">nl.vroste.rezilience._</span>
<span class="k">import</span> <span class="nn">zio._</span>
<span class="k">import</span> <span class="nn">zio.clock.Clock</span>
<span class="k">import</span> <span class="nn">zio.console.putStrLn</span>
<span class="k">import</span> <span class="nn">zio.duration._</span>

<span class="k">object</span> <span class="nc">CircuitBreakerExample</span> <span class="o">{</span>
  <span class="c1">// We use Throwable as error type in this example</span>
  <span class="k">def</span> <span class="nf">callExternalSystem</span><span class="o">(</span><span class="n">someInput</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Throwable</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nv">ZIO</span><span class="o">.</span><span class="py">succeed</span><span class="o">(</span><span class="nv">someInput</span><span class="o">.</span><span class="py">length</span><span class="o">)</span>

  <span class="k">val</span> <span class="nv">circuitBreaker</span><span class="k">:</span> <span class="kt">ZManaged</span><span class="o">[</span><span class="kt">Clock</span>, <span class="kt">Nothing</span>, <span class="kt">CircuitBreaker</span><span class="o">[</span><span class="kt">Any</span><span class="o">]]</span> <span class="k">=</span> <span class="nv">CircuitBreaker</span><span class="o">.</span><span class="py">make</span><span class="o">(</span>
    <span class="n">trippingStrategy</span> <span class="k">=</span> <span class="nv">TrippingStrategy</span><span class="o">.</span><span class="py">failureCount</span><span class="o">(</span><span class="n">maxFailures</span> <span class="k">=</span> <span class="mi">10</span><span class="o">),</span>
    <span class="n">resetPolicy</span> <span class="k">=</span> <span class="nv">Retry</span><span class="o">.</span><span class="py">Schedules</span><span class="o">.</span><span class="py">exponentialBackoff</span><span class="o">(</span><span class="n">min</span> <span class="k">=</span> <span class="mf">1.</span><span class="n">second</span><span class="o">,</span> <span class="n">max</span> <span class="k">=</span> <span class="mf">1.</span><span class="n">minute</span><span class="o">)</span>
  <span class="o">)</span>

  <span class="nv">circuitBreaker</span><span class="o">.</span><span class="py">use</span> <span class="o">{</span> <span class="n">cb</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="nv">result</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">CircuitBreakerCallError</span><span class="o">[</span><span class="kt">Throwable</span><span class="o">]</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nf">cb</span><span class="o">(</span><span class="nf">callExternalSystem</span><span class="o">(</span><span class="s">"some input"</span><span class="o">))</span>

    <span class="n">result</span>
      <span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="n">r</span> <span class="k">=&gt;</span> <span class="nf">putStrLn</span><span class="o">(</span><span class="n">s</span><span class="s">"External system returned $r"</span><span class="o">))</span>
      <span class="o">.</span><span class="py">catchSome</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">CircuitBreakerOpen</span> <span class="k">=&gt;</span>
          <span class="nf">putStrLn</span><span class="o">(</span><span class="s">"Circuit breaker blocked the call to our external system"</span><span class="o">)</span>
        <span class="k">case</span> <span class="nc">WrappedError</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>    <span class="k">=&gt;</span>
          <span class="nf">putStrLn</span><span class="o">(</span><span class="n">s</span><span class="s">"External system threw an exception: $e"</span><span class="o">)</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="responding-to-a-subset-of-errors">Responding to a subset of errors</h2>
<p>Often you will want the Circuit Breaker to respond only to certain types of errors from your external system call, while passing through other errors that indicate normal operation. Use the <code class="language-plaintext highlighter-rouge">isFailure</code> parameter of <code class="language-plaintext highlighter-rouge">CircuitBreaker.make</code> to define which errors are regarded by the Circuit Breaker.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Error</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">ServiceError</span>     <span class="k">extends</span> <span class="nc">Error</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">UserError</span> <span class="k">extends</span> <span class="nc">Error</span>

<span class="k">val</span> <span class="nv">isFailure</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Error</span>, <span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">UserError</span> <span class="k">=&gt;</span> <span class="kc">false</span>
  <span class="k">case</span> <span class="k">_:</span> <span class="kt">Error</span>        <span class="o">=&gt;</span> <span class="kc">true</span>
<span class="o">}</span>

<span class="k">def</span> <span class="nf">callWithServiceError</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Error</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nv">ZIO</span><span class="o">.</span><span class="py">fail</span><span class="o">(</span><span class="nc">ServiceError</span><span class="o">)</span>
<span class="k">def</span> <span class="nf">callWithUserError</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Error</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nv">ZIO</span><span class="o">.</span><span class="py">fail</span><span class="o">(</span><span class="nc">UserError</span><span class="o">)</span>

<span class="nv">CircuitBreaker</span><span class="o">.</span><span class="py">make</span><span class="o">(</span>
  <span class="n">trippingStrategy</span> <span class="k">=</span> <span class="nv">TrippingStrategy</span><span class="o">.</span><span class="py">failureCount</span><span class="o">(</span><span class="n">maxFailures</span> <span class="k">=</span> <span class="mi">10</span><span class="o">),</span>
  <span class="n">isFailure</span> <span class="k">=</span> <span class="n">isFailure</span>
<span class="o">).</span><span class="py">use</span> <span class="o">{</span> <span class="n">circuitBreaker</span> <span class="k">=&gt;</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">circuitBreaker</span><span class="o">(</span><span class="n">callWithUserError</span><span class="o">)</span> <span class="c1">// Will not be counted as failure by the circuit breaker</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">circuitBreaker</span><span class="o">(</span><span class="n">callWithServiceError</span><span class="o">)</span> <span class="c1">// Will be counted as failure</span>
  <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="monitoring">Monitoring</h2>
<p>You may want to monitor circuit breaker failures and trigger alerts when the circuit breaker trips. For this purpose, CircuitBreaker publishes state changes via a callback provided to <code class="language-plaintext highlighter-rouge">make</code>. Usage:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CircuitBreaker</span><span class="o">.</span><span class="py">make</span><span class="o">(</span>
  <span class="n">trippingStrategy</span> <span class="k">=</span> <span class="nv">TrippingStrategy</span><span class="o">.</span><span class="py">failureCount</span><span class="o">(</span><span class="n">maxFailures</span> <span class="k">=</span> <span class="mi">10</span><span class="o">),</span>
  <span class="n">onStateChange</span> <span class="k">=</span> <span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">State</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">ZIO</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"State changed to ${s}"</span><span class="o">)).</span><span class="py">ignore</span>
<span class="o">).</span><span class="py">use</span> <span class="o">{</span> <span class="n">circuitBreaker</span> <span class="k">=&gt;</span>
  <span class="c1">// Make calls to an external system</span>
  <span class="nf">circuitBreaker</span><span class="o">(</span><span class="nv">ZIO</span><span class="o">.</span><span class="py">unit</span><span class="o">)</span> <span class="c1">// etc</span>
<span class="o">}</span>
</code></pre></div></div>
</section></div></div></div></div><script src="/highlight/highlight.pack.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/js/docs.js"></script></body></html>
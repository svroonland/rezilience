<!DOCTYPE html><html><head><title>rezilience: General Usage</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="vroste" /><meta name="description" content="ZIO-native utilities for making asynchronous systems more resilient to failures" /><meta name="og:image" content="/rezilience/img/poster.png" /><meta name="image" property="og:image" content="/rezilience/img/poster.png" /><meta name="og:title" content="rezilience: General Usage" /><meta name="title" property="og:title" content="rezilience: General Usage" /><meta name="og:site_name" content="rezilience" /><meta name="og:url" content="https://svroonland.github.io/rezilience/" /><meta name="og:type" content="website" /><meta name="og:description" content="ZIO-native utilities for making asynchronous systems more resilient to failures" /><link rel="icon" type="image/png" href="/rezilience/img/favicon.png" /><meta name="twitter:title" content="rezilience: General Usage" /><meta name="twitter:image" content="https://svroonland.github.io/rezilience/img/poster.png" /><meta name="twitter:description" content="ZIO-native utilities for making asynchronous systems more resilient to failures" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@vroste" /><link rel="icon" type="image/png" sizes="16x16" href="/rezilience/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/rezilience/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/rezilience/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/rezilience/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/rezilience/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/rezilience/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/rezilience/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/rezilience/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/rezilience/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/rezilience/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/rezilience/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/rezilience/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/rezilience/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/rezilience/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/rezilience/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/rezilience/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/rezilience/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/rezilience/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/rezilience/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/rezilience/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/rezilience/highlight/styles/vs.css" /><link rel="stylesheet" href="/rezilience/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/rezilience/" class="brand"><div class="brand-wrapper"></div><span>rezilience</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/rezilience/docs/" title="Getting started" class="">Getting started</a></div> <div class="sidebar-nav-item active "><a href="/rezilience/docs/general_usage" title="General Usage" class="active">General Usage</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/circuitbreaker" title="Circuit Breaker" class="">Circuit Breaker</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/bulkhead" title="Bulkhead" class="">Bulkhead</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/ratelimiter" title="Rate Limiter" class="">Rate Limiter</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/retry" title="Retry" class="">Retry</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/combining_policies" title="Combining Policies" class="">Combining Policies</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/additional_resiliency" title="Additional Resiliency" class="">Additional Resiliency</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/api/nl/vroste/rezilience/" title="API reference" class="">API reference</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/svroonland/rezilience" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/svroonland/rezilience" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="svroonland" data-github-repo="rezilience"><div class="content-wrapper"><section><h1 id="general-usage">General usage</h1>

<p><code class="language-plaintext highlighter-rouge">rezilience</code> policies are created as <code class="language-plaintext highlighter-rouge">ZManaged</code> resources. This allows them to run background operations which are cleaned up safely after usage. Since these <code class="language-plaintext highlighter-rouge">ZManaged</code>s are just descriptions of the policy, they can be passed around to various call sites and <code class="language-plaintext highlighter-rouge">use</code>d to create many instances.</p>

<p>All instantiated policies are defined as traits with an <code class="language-plaintext highlighter-rouge">apply</code> method that takes a ZIO effect as parameter. Therefore a policy can be used as if it were a function taking a ZIO effect, eg:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Retry</span><span class="o">.</span><span class="py">make</span><span class="o">(...).</span><span class="py">use</span> <span class="o">{</span> <span class="n">retryPolicy</span> <span class="k">=&gt;</span> 
  <span class="nf">retryPolicy</span><span class="o">(</span><span class="n">callToExternalSystem</span><span class="o">)</span> <span class="c1">// shorthand for retryPolicy.apply(callToExternalSystem) </span>
<span class="o">}</span>
</code></pre></div></div>

<p>Some policies do not require any type information upon their creation, all types are inferred during usage (calling <code class="language-plaintext highlighter-rouge">apply</code> like in the example above). Other policies can have behavior that is dependent on the type of error of the effects they are applied on. They can only be applied on effects with an <code class="language-plaintext highlighter-rouge">E</code> that is a subtype of the errors that the policy is defined for. For example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">isFailure</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Error</span>, <span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">MyNotFatalError</span> <span class="k">=&gt;</span> <span class="kc">false</span>
  <span class="k">case</span> <span class="k">_:</span> <span class="kt">Error</span>        <span class="o">=&gt;</span> <span class="kc">true</span>
<span class="o">}</span>

<span class="nv">CircuitBreaker</span><span class="o">.</span><span class="py">withMaxFailures</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">isFailure</span> <span class="k">=</span> <span class="n">isFailure</span><span class="o">).</span><span class="py">use</span> <span class="o">{</span> <span class="n">circuitBreaker</span> <span class="k">=&gt;</span> 
  <span class="nf">circuitBreaker</span><span class="o">(</span><span class="n">callToExternalSystem</span><span class="o">)</span> 
<span class="o">}</span>
</code></pre></div></div>

<h2 id="zlayer-integration">ZLayer integration</h2>
<p>You can apply <code class="language-plaintext highlighter-rouge">rezilience</code> policies at the level of an individual ZIO effect. But having to wrap all your calls in eg a rate limiter can clutter your code somewhat. When you are using the ZIO module pattern using <code class="language-plaintext highlighter-rouge">ZLayer</code>, it is also possible to integrate a <code class="language-plaintext highlighter-rouge">rezilience</code> policy with some service at the <code class="language-plaintext highlighter-rouge">ZLayer</code> level. In the spirit of aspect oriented programming, the code using your service will not be cluttered with the aspect of rate limiting.</p>

<p>For example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">addRateLimiterToDatabase</span><span class="k">:</span> <span class="kt">ZLayer</span><span class="o">[</span><span class="kt">Database</span> <span class="kt">with</span> <span class="kt">Clock</span>, <span class="kt">Nothing</span>, <span class="kt">Database</span><span class="o">]</span> <span class="k">=</span>
<span class="nv">ZLayer</span><span class="o">.</span><span class="py">fromServiceManaged</span> <span class="o">{</span> <span class="n">database</span><span class="k">:</span> <span class="kt">Database.Service</span> <span class="o">=&gt;</span>
  <span class="nv">RateLimiter</span><span class="o">.</span><span class="py">make</span><span class="o">(</span><span class="mi">10</span><span class="o">).</span><span class="py">map</span> <span class="o">{</span> <span class="n">rateLimiter</span> <span class="k">=&gt;</span>
    <span class="k">new</span> <span class="nv">Database</span><span class="o">.</span><span class="py">Service</span> <span class="o">{</span>
      <span class="k">override</span> <span class="k">def</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">Amount</span><span class="o">,</span> <span class="n">from</span><span class="k">:</span> <span class="kt">Account</span><span class="o">,</span> <span class="n">to</span><span class="k">:</span> <span class="kt">Account</span><span class="o">)</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Throwable</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
        <span class="nf">rateLimiter</span><span class="o">(</span><span class="nv">database</span><span class="o">.</span><span class="py">transfer</span><span class="o">(</span><span class="n">amount</span><span class="o">,</span> <span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">env</span><span class="k">:</span> <span class="kt">ZLayer</span><span class="o">[</span><span class="kt">Clock</span>, <span class="kt">Nothing</span>, <span class="kt">Database</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span><span class="nv">Clock</span><span class="o">.</span><span class="py">live</span> <span class="o">++</span> <span class="n">databaseLayer</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">addRateLimiterToDatabase</span>
</code></pre></div></div>

<p>This works well for policies that do not alter the error type like RateLimiter and Retry, but for policies that do alter the error type, you will need to map eg a <code class="language-plaintext highlighter-rouge">CircuitBreakerOpen</code> to the error type in your service definition. If your serviceâ€™s error type is something like <code class="language-plaintext highlighter-rouge">Throwable</code>, you can throw any new kind of exception, but for custom error types this is not possible. In that case you can define a new service type like <code class="language-plaintext highlighter-rouge">ResilientDatabase</code> where the error types are <code class="language-plaintext highlighter-rouge">PolicyError[E]</code>.</p>

<p>See the <a href="rezilience/shared/src/test/scala/nl/vroste/rezilience/examples/ZLayerIntegrationExample.scala">full example</a> for more.</p>

</section></div></div></div></div><script src="/rezilience/highlight/highlight.pack.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/rezilience/js/docs.js"></script></body></html>
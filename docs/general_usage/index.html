<!DOCTYPE html><html><head><title>rezilience: General Usage</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="vroste" /><meta name="description" content="ZIO-native utilities for making asynchronous systems more resilient to failures" /><meta name="og:image" content="/rezilience/img/poster.png" /><meta name="image" property="og:image" content="/rezilience/img/poster.png" /><meta name="og:title" content="rezilience: General Usage" /><meta name="title" property="og:title" content="rezilience: General Usage" /><meta name="og:site_name" content="rezilience" /><meta name="og:url" content="https://svroonland.github.io/rezilience/" /><meta name="og:type" content="website" /><meta name="og:description" content="ZIO-native utilities for making asynchronous systems more resilient to failures" /><link rel="icon" type="image/png" href="/rezilience/img/favicon.png" /><meta name="twitter:title" content="rezilience: General Usage" /><meta name="twitter:image" content="https://svroonland.github.io/rezilience/img/poster.png" /><meta name="twitter:description" content="ZIO-native utilities for making asynchronous systems more resilient to failures" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@vroste" /><link rel="icon" type="image/png" sizes="16x16" href="/rezilience/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/rezilience/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/rezilience/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/rezilience/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/rezilience/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/rezilience/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/rezilience/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/rezilience/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/rezilience/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/rezilience/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/rezilience/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/rezilience/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/rezilience/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/rezilience/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/rezilience/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/rezilience/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/rezilience/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/rezilience/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/rezilience/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/rezilience/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/rezilience/highlight/styles/vs.css" /><link rel="stylesheet" href="/rezilience/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/rezilience/" class="brand"><div class="brand-wrapper"></div><span>rezilience</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/rezilience/docs/" title="Getting started" class="">Getting started</a></div> <div class="sidebar-nav-item active "><a href="/rezilience/docs/general_usage" title="General Usage" class="active">General Usage</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/circuitbreaker" title="Circuit Breaker" class="">Circuit Breaker</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/bulkhead" title="Bulkhead" class="">Bulkhead</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/ratelimiter" title="Rate Limiter" class="">Rate Limiter</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/retry" title="Retry" class="">Retry</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/timeout" title="Timeout" class="">Timeout</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/combining_policies" title="Combining Policies" class="">Combining Policies</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/switching_policies" title="Switching Policies" class="">Switching Policies</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/zio-config" title="zio-config Integration" class="">zio-config Integration</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/docs/additional_resiliency" title="Additional Resiliency" class="">Additional Resiliency</a></div> <div class="sidebar-nav-item  "><a href="/rezilience/api/nl/vroste/rezilience/" title="API reference" class="">API reference</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/svroonland/rezilience" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/svroonland/rezilience" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="svroonland" data-github-repo="rezilience"><div class="content-wrapper"><section><h1 id="general-usage">General usage</h1>

<p><code class="language-plaintext highlighter-rouge">rezilience</code> policies are created as <a href="https://zio.dev/docs/datatypes/datatypes_managed"><code class="language-plaintext highlighter-rouge">Scoped</code></a> effects. This allows them to run background operations which are cleaned up safely after usage. Since these scoped effects are just descriptions of the policy, they can be passed around to various call sites and used to create many instances.</p>

<p>All instantiated policies are defined as traits with an <code class="language-plaintext highlighter-rouge">apply</code> method that takes a ZIO effect as parameter:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Retry</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">apply</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">E</span>, <span class="kt">A</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">E</span>, <span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">E</span>, <span class="kt">A</span><span class="o">]</span>
<span class="o">}</span>

</code></pre></div></div>

<p>Therefore a policy can be used as if it were a function taking a ZIO effect, eg:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ZIO</span><span class="o">.</span><span class="py">scoped</span> <span class="o">{</span>
  <span class="nv">Retry</span><span class="o">.</span><span class="py">make</span><span class="o">(...).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">retry</span> <span class="k">=&gt;</span>
    <span class="nf">retry</span><span class="o">(</span><span class="n">callToExternalSystem</span><span class="o">)</span> <span class="c1">// shorthand for retry.apply(callToExternalSystem) </span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Policies can be applied to any type of <code class="language-plaintext highlighter-rouge">ZIO[R, E, A]</code> effect, although some policies have an upper bound for <code class="language-plaintext highlighter-rouge">E</code> depending on how they are created. Some policies alter the return error type, others leave it as is:</p>

<table>
  <thead>
    <tr>
      <th>Policy</th>
      <th>Error type upper bound</th>
      <th>Result type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CircuitBreaker</td>
      <td><code class="language-plaintext highlighter-rouge">Any</code>, or <code class="language-plaintext highlighter-rouge">E</code> (when <code class="language-plaintext highlighter-rouge">isFailure</code> parameter is used)</td>
      <td><code class="language-plaintext highlighter-rouge">ZIO[R, CircuitBreakerError[E], A]</code></td>
    </tr>
    <tr>
      <td>RateLimiter</td>
      <td><code class="language-plaintext highlighter-rouge">Any</code></td>
      <td><code class="language-plaintext highlighter-rouge">ZIO[R, E, A]</code></td>
    </tr>
    <tr>
      <td>Bulkhead</td>
      <td><code class="language-plaintext highlighter-rouge">Any</code></td>
      <td><code class="language-plaintext highlighter-rouge">ZIO[R, BulkheadError[E], A]</code></td>
    </tr>
    <tr>
      <td>Retry</td>
      <td><code class="language-plaintext highlighter-rouge">Any</code>, or <code class="language-plaintext highlighter-rouge">E</code> when a <code class="language-plaintext highlighter-rouge">Schedule[Env, E, Out]</code> is used</td>
      <td><code class="language-plaintext highlighter-rouge">ZIO[R, E, A]</code></td>
    </tr>
    <tr>
      <td>Timeout</td>
      <td><code class="language-plaintext highlighter-rouge">Any</code></td>
      <td><code class="language-plaintext highlighter-rouge">ZIO[R, TimeoutError[E], A]</code></td>
    </tr>
  </tbody>
</table>

<h2 id="mapping-errors">Mapping errors</h2>

<p><code class="language-plaintext highlighter-rouge">rezilience</code> policies are type-safe in the error channel, which means that some of them change the error type of the effects they are applied to (see table above). For example, applying a <code class="language-plaintext highlighter-rouge">CircuitBreaker</code> to an effect of type <code class="language-plaintext highlighter-rouge">ZIO[Any, Throwable, Unit]</code> will result in a <code class="language-plaintext highlighter-rouge">ZIO[Any, CircuitBreakerError[Throwable], Unit]</code>.</p>

<p>This <code class="language-plaintext highlighter-rouge">CircuitBreakerError</code> has two subtypes:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">case object CircuitBreakerOpen</code>: the error when the circuit breaker has tripped and no attempt to make the call has been made</li>
  <li><code class="language-plaintext highlighter-rouge">case class WrappedError[E](error: E)</code>: the error coming from the call</li>
</ul>

<p>By having this datatype for errors, <code class="language-plaintext highlighter-rouge">rezilience</code> requires you to be explicit in how you want to handle circuit breaker errors, in line with the rest of ZIO’s strategy for typed error handling. At a higher level in your application you may want to inform the user that a system is temporarily not available or execute some  fallback logic.</p>

<p>Several conveniences are available for dealing with circuit breaker errors:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">CircuitBreakerError#fold[O](circuitBreakerOpen: O, unwrap: E =&gt; O)</code><br />
Convert a <code class="language-plaintext highlighter-rouge">CircuitBreakerOpen</code> or a <code class="language-plaintext highlighter-rouge">WrappedError</code> into an <code class="language-plaintext highlighter-rouge">O</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">CircuitBreakerError#toException</code><br />
Converts a <code class="language-plaintext highlighter-rouge">CircuitBreakerError</code> to a <code class="language-plaintext highlighter-rouge">CircuitBreakerException</code>.</li>
</ul>

<p>For example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">MyServiceErrorType</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">SystemNotInTheMood</span> <span class="k">extends</span> <span class="nc">MyServiceErrorType</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">UnknownServiceError</span> <span class="k">extends</span> <span class="nc">MyServiceErrorType</span>

<span class="k">def</span> <span class="nf">callExternalSystem</span><span class="o">(</span><span class="n">someInput</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">MyServiceErrorType</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> 
  <span class="nv">ZIO</span><span class="o">.</span><span class="py">succeed</span><span class="o">(</span><span class="nv">someInput</span><span class="o">.</span><span class="py">length</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">result1</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">CircuitBreakerError</span><span class="o">[</span><span class="kt">MyServiceErrorType</span><span class="o">]</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> 
  <span class="nf">circuitBreaker</span><span class="o">(</span><span class="nf">callExternalSystem</span><span class="o">(</span><span class="s">"1234"</span><span class="o">))</span>

<span class="c1">// Map the CircuitBreakerError back onto an UnknownServiceError</span>
<span class="k">val</span> <span class="nv">result2</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">MyServiceErrorType</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> 
  <span class="nv">result1</span><span class="o">.</span><span class="py">mapError</span><span class="o">(</span><span class="n">policyError</span> <span class="k">=&gt;</span> <span class="nv">policyError</span><span class="o">.</span><span class="py">fold</span><span class="o">(</span><span class="nc">UnknownServiceError</span><span class="o">,</span> <span class="nf">identity</span><span class="o">(</span><span class="k">_</span><span class="o">)))</span>

<span class="c1">// Or turn it into an exception</span>
<span class="k">val</span> <span class="nv">result3</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Throwable</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">result1</span><span class="o">.</span><span class="py">mapError</span><span class="o">(</span><span class="n">policyError</span> <span class="k">=&gt;</span> <span class="nv">policyError</span><span class="o">.</span><span class="py">toException</span><span class="o">)</span>
</code></pre></div></div>

<p>Similar methods exist on <code class="language-plaintext highlighter-rouge">BulkheadError</code> and <code class="language-plaintext highlighter-rouge">PolicyError</code> (see <a href="../bulkhead">Bulkhead</a> and <a href="../combining_policies">Combining Policies</a>)</p>

<h2 id="zlayer-integration">ZLayer integration</h2>
<p>You can apply <code class="language-plaintext highlighter-rouge">rezilience</code> policies at the level of an individual ZIO effect. But having to wrap all your calls in eg a rate limiter can clutter your code somewhat. When you are using the <a href="https://zio.dev/docs/howto/howto_use_layers">ZIO module pattern</a> using <code class="language-plaintext highlighter-rouge">ZLayer</code>, it is also possible to integrate a <code class="language-plaintext highlighter-rouge">rezilience</code> policy with some service at the <code class="language-plaintext highlighter-rouge">ZLayer</code> level. In the spirit of aspect oriented programming, the code using your service will not be cluttered with the aspect of rate limiting.</p>

<p>For example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">addRateLimiterToDatabase</span><span class="k">:</span> <span class="kt">ZLayer</span><span class="o">[</span><span class="kt">Database</span>, <span class="kt">Nothing</span>, <span class="kt">Database</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nv">ZLayer</span><span class="o">.</span><span class="py">scoped</span> <span class="o">{</span>
    <span class="nv">ZLayer</span><span class="o">.</span><span class="py">fromService</span> <span class="o">{</span> <span class="n">database</span><span class="k">:</span> <span class="kt">Database.Service</span> <span class="o">=&gt;</span>
      <span class="nv">RateLimiter</span><span class="o">.</span><span class="py">make</span><span class="o">(</span><span class="mi">10</span><span class="o">).</span><span class="py">map</span> <span class="o">{</span> <span class="n">rateLimiter</span> <span class="k">=&gt;</span>
        <span class="k">new</span> <span class="nv">Database</span><span class="o">.</span><span class="py">Service</span> <span class="o">{</span>
          <span class="k">override</span> <span class="k">def</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">Amount</span><span class="o">,</span> <span class="n">from</span><span class="k">:</span> <span class="kt">Account</span><span class="o">,</span> <span class="n">to</span><span class="k">:</span> <span class="kt">Account</span><span class="o">)</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Throwable</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
            <span class="nf">rateLimiter</span><span class="o">(</span><span class="nv">database</span><span class="o">.</span><span class="py">transfer</span><span class="o">(</span><span class="n">amount</span><span class="o">,</span> <span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">))</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>For policies where the result type has a different <code class="language-plaintext highlighter-rouge">E</code> you will need to map the error back to your own <code class="language-plaintext highlighter-rouge">E</code>. An option is to have something like a general <code class="language-plaintext highlighter-rouge">case class UnknownServiceError(e: Exception)</code> in your service error type, to which you can map the policy errors. If that is not possible for some reason, you can also define a new service type like <code class="language-plaintext highlighter-rouge">ResilientDatabase</code> where the error types are <code class="language-plaintext highlighter-rouge">PolicyError[E]</code>.</p>

<p>See the <a href="https://github.com/svroonland/rezilience/blob/master/rezilience/shared/src/test/scala/nl/vroste/rezilience/examples/ZLayerIntegrationExample.scala">full example</a> for more.</p>
</section></div></div></div></div><script src="/rezilience/highlight/highlight.pack.js"></script><script src="/rezilience/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/rezilience/js/search.js"></script><script src="/rezilience/js/docs.js"></script></body></html>